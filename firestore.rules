rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is a collaborator on a project
    function isCollaborator(hostUid, projectId) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(hostUid)/projects/$(projectId)) &&
             request.auth.uid in get(/databases/$(database)/documents/users/$(hostUid)/projects/$(projectId)).data.get('collaborators', []);
    }

    // [IMPORTANT] Support collectionGroup('projects') queries
    match /{path=**}/projects/{projectId} {
      allow read: if (resource.data.get('collaborationEnabled', false) == true) || 
                   (request.auth != null && (
                     request.auth.uid in resource.data.get('collaborators', []) ||
                     // Check if user is the owner (path is users/{userId})
                     (path.size() >= 2 && path[0] == 'users' && path[1] == request.auth.uid)
                   ));
    }

    // User Data
    match /users/{userId} {
      // Owner has full access
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // [Discovery] Allow anyone (including logged out) to 'get' user's doc to see their name 
      // (Used in invitations and collaborator lists)
      allow get: if true;

      // Allow finding user by activeSharedIds (Viewer Mode)
      allow list: if (resource.data.get('activeSharedIds', []).size() > 0);

      // Projects Subcollection
      match /projects/{projectId} {
        // Owner has full access
        allow read, write: if request.auth != null && request.auth.uid == userId;

        // Allow reading if:
        // 1. Any user (even logged out) can read IF collaboration is active (for landing page preview)
        // 2. User is already a collaborator
        allow read: if (resource.data.get('collaborationEnabled', false) == true) || 
                     (request.auth != null && request.auth.uid in resource.data.get('collaborators', []));

        // Allow updating if already a collaborator OR if joining (adding oneself)
        // Simplified check for joining to be more robust
        allow update: if request.auth != null && (
          request.auth.uid in resource.data.get('collaborators', []) ||
          (
            resource.data.get('collaborationEnabled', false) == true &&
            request.resource.data.collaborators.hasAll(resource.data.get('collaborators', [])) &&
            request.auth.uid in request.resource.data.collaborators
          )
        );
      }

      // Transactions Subcollection
      match /transactions/{txId} {
        // Owner has full access
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        // [Viewer Mode]
        allow read: if get(/databases/$(database)/documents/users/$(userId)).data.get('activeSharedIds', []).size() > 0;

        // [Collaboration Mode]
        // Allow collaborators to read/write transactions belonging to the shared project
        allow read: if request.auth != null && 
                       resource.data.get('projectId', '') != '' && 
                       isCollaborator(userId, resource.data.projectId);
        
        allow write: if request.auth != null && 
                        (
                          (request.resource.data.get('projectId', '') != '' && isCollaborator(userId, request.resource.data.projectId)) ||
                          (resource != null && resource.data.get('projectId', '') != '' && isCollaborator(userId, resource.data.projectId))
                        );
      }

      // Shared Links Config
      match /shared_links/{linkId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        allow get: if true; 
      }
    }

    // Friend Connections (Mutual Linking Signal)
    match /friend_connections/{connId} {
      allow create: if request.auth != null;
      allow read, delete: if request.auth != null && resource.data.toUid == request.auth.uid;
    }

    // Short Invitation Codes
    match /short_invites/{shortId} {
      allow get: if true;
      allow create: if request.auth != null;
    }
  }
}
